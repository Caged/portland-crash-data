#!/bin/sh

database=crashes
schema_source="raw/2012-n.mdb"
export_dir="export"

dropdb --if-exists --interactive $database
createdb $database
psql -c "create extension postgis" -d $database

mdb-schema $schema_source postgres > schema.sql
sed -i "" -e 's/BOOL NOT NULL/SMALLINT/g' schema.sql
sed -i "" -e 's/BOOL NOT NULL/SMALLINT/g' schema.sql

psql -f schema.sql -d $database

for table in $(mdb-tables $schema_source); do \
  if [ "$table" == "CRASH" ] || [ "$table" == "CRASH_KEY_XREF" ] || [ "$table" == "PARTIC" ] || [ "$table" == "VHCL" ]; then \
    echo $table
  else
    mdb-export -I postgres -q \' $schema_source $table | psql -d $database
  fi
done

for db in raw/*.mdb; do \
  mdb-export -I postgres -q \' $db CRASH | psql -d $database
  mdb-export -I postgres -q \' $db CRASH_KEY_XREF | psql -d $database
  mdb-export -I postgres -q \' $db PARTIC | psql -d $database
  mdb-export -I postgres -q \' $db VHCL | psql -d $database
done
